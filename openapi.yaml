openapi: 3.1.0
info:
  title: anthropic-headless-api
  description: |
    OpenAI-compatible API server wrapping Claude Code CLI.

    ## Key Differences from OpenAI API

    This API uses **stateful sessions** instead of stateless requests:
    - First request creates a session, response includes `session_id`
    - Pass `session_id` in subsequent requests to continue conversation
    - Claude maintains full context internally (no need to resend history)

    ## Session Continuity

    ```
    Request 1: { messages: [...] }
    Response 1: { session_id: "abc123", ... }

    Request 2: { session_id: "abc123", messages: [new_message] }
    Response 2: { session_id: "abc123", ... }  // Claude remembers context
    ```
  version: 0.2.0
  contact:
    name: anthropic-headless-api
  license:
    name: MIT

servers:
  - url: http://localhost:3456
    description: Local development server

tags:
  - name: Chat
    description: Chat completion endpoints
  - name: Models
    description: Model information
  - name: Health
    description: Health and status endpoints

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Returns server status and version information
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /v1/models:
    get:
      tags: [Models]
      summary: List available models
      description: Returns list of available models (always claude-code-cli)
      operationId: listModels
      responses:
        '200':
          description: List of models
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsResponse'
        '429':
          $ref: '#/components/responses/RateLimited'

  /v1/chat/completions:
    post:
      tags: [Chat]
      summary: Create chat completion
      description: |
        Creates a chat completion using Claude Code CLI.

        **Session Continuity:**
        - Omit `session_id` to start new conversation
        - Include `session_id` from previous response to continue
        - Response always includes `session_id` for next request
      operationId: createChatCompletion
      parameters:
        - name: X-Session-Id
          in: header
          description: Alternative to session_id in body
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatCompletionRequest'
            examples:
              newConversation:
                summary: Start new conversation
                value:
                  messages:
                    - role: system
                      content: You are a helpful assistant.
                    - role: user
                      content: What is the capital of France?
              continueConversation:
                summary: Continue existing conversation
                value:
                  session_id: 01abc123-def4-5678-90ab-cdef12345678
                  messages:
                    - role: user
                      content: What is its population?
              streaming:
                summary: Streaming response
                value:
                  stream: true
                  messages:
                    - role: user
                      content: Tell me a story
      responses:
        '200':
          description: Chat completion response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatCompletionResponse'
            text/event-stream:
              schema:
                type: string
                description: Server-sent events stream
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/RateLimited'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  schemas:
    # Request Schemas
    ChatCompletionRequest:
      type: object
      required:
        - messages
      properties:
        model:
          type: string
          description: "Model: opus, sonnet, haiku, or full model name"
          example: opus
        messages:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/ChatMessage'
          description: Array of messages in the conversation
        max_tokens:
          type: integer
          minimum: 1
          description: Maximum tokens to generate
        temperature:
          type: number
          minimum: 0
          maximum: 2
          description: Sampling temperature
        stream:
          type: boolean
          default: false
          description: Enable streaming responses
        system:
          type: string
          description: System prompt override
        working_directory:
          type: string
          description: Working directory for context (reads CONTEXT.md)
        context_files:
          type: array
          items:
            type: string
          description: Additional context files to include
        session_id:
          type: string
          format: uuid
          description: Session ID for conversation continuity

        # Tool Control
        tools:
          oneOf:
            - type: array
              items:
                type: string
            - type: string
              enum: ['default', '']
          description: "Available tools: array, 'default', or '' to disable all"
        allowed_tools:
          type: array
          items:
            type: string
          description: Tools allowed without prompting
          example: ["Read", "Grep", "Glob"]
        disallowed_tools:
          type: array
          items:
            type: string
          description: Tools explicitly denied
          example: ["Write", "Bash"]

        # Budget & Permissions
        max_budget_usd:
          type: number
          minimum: 0
          description: Maximum spend in USD for this request
        permission_mode:
          type: string
          enum: [default, plan, acceptEdits, bypassPermissions, delegate, dontAsk]
          description: Permission mode for tool execution

        # System Prompt
        append_system_prompt:
          type: string
          description: Append to default system prompt instead of replacing

        # Structured Output
        json_schema:
          type: object
          description: JSON Schema for structured output validation
          example:
            type: object
            properties:
              name:
                type: string
            required: [name]

        # Agent Control
        agent:
          type: string
          description: Use specific agent for this session
          example: Explore
        agents:
          type: object
          additionalProperties:
            type: object
            properties:
              description:
                type: string
              prompt:
                type: string
              allowed_tools:
                type: array
                items:
                  type: string
          description: Define custom agents inline

        # Session Control
        continue_conversation:
          type: boolean
          description: Continue most recent conversation (alternative to session_id)
        fork_session:
          type: boolean
          description: Fork session instead of reusing when resuming
        ephemeral:
          type: boolean
          description: Disable session persistence

        # Directory Access
        add_dirs:
          type: array
          items:
            type: string
          description: Additional directories to allow tool access

        # Resilience
        fallback_model:
          type: string
          description: Fallback model when primary is overloaded

        # MCP Integration
        mcp_config:
          type: array
          items:
            type: string
          description: MCP server configurations (JSON strings or file paths)
        strict_mcp_config:
          type: boolean
          description: Only use specified MCP servers

        # Advanced
        verbose:
          type: boolean
          description: Enable verbose output
        betas:
          type: array
          items:
            type: string
          description: Beta features to enable

    ChatMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [system, user, assistant]
          description: The role of the message author
        content:
          type: string
          minLength: 1
          description: The content of the message
        name:
          type: string
          description: Optional name for the message author

    # Response Schemas
    ChatCompletionResponse:
      type: object
      required:
        - id
        - object
        - created
        - model
        - choices
        - usage
      properties:
        id:
          type: string
          description: Unique completion identifier
          example: chatcmpl-1234567890-abc123
        object:
          type: string
          enum: [chat.completion]
        created:
          type: integer
          description: Unix timestamp
        model:
          type: string
          example: claude-code-cli
        choices:
          type: array
          items:
            $ref: '#/components/schemas/ChatCompletionChoice'
        usage:
          $ref: '#/components/schemas/UsageInfo'
        session_id:
          type: string
          format: uuid
          description: Session ID for continuing conversation
        claude_metadata:
          $ref: '#/components/schemas/ClaudeMetadata'

    ChatCompletionChoice:
      type: object
      required:
        - index
        - message
        - finish_reason
      properties:
        index:
          type: integer
        message:
          $ref: '#/components/schemas/ChatMessage'
        finish_reason:
          type: string
          enum: [stop, length, content_filter]
          nullable: true

    UsageInfo:
      type: object
      required:
        - prompt_tokens
        - completion_tokens
        - total_tokens
      properties:
        prompt_tokens:
          type: integer
          description: Tokens in the prompt
        completion_tokens:
          type: integer
          description: Tokens in the completion
        total_tokens:
          type: integer
          description: Total tokens used
        cache_read_tokens:
          type: integer
          description: Tokens read from prompt cache (cheaper)
        cache_creation_tokens:
          type: integer
          description: Tokens written to prompt cache

    ClaudeMetadata:
      type: object
      description: Rich metadata from Claude CLI execution
      properties:
        durationMs:
          type: integer
          description: Total execution time in milliseconds
        durationApiMs:
          type: integer
          description: API call duration in milliseconds
        numTurns:
          type: integer
          description: Number of conversation turns
        totalCostUsd:
          type: number
          description: Total cost in USD
        usage:
          type: object
          properties:
            inputTokens:
              type: integer
            outputTokens:
              type: integer
            cacheCreationTokens:
              type: integer
            cacheReadTokens:
              type: integer
        uuid:
          type: string
          description: Unique execution identifier

    # Streaming Schemas
    ChatCompletionChunk:
      type: object
      required:
        - id
        - object
        - created
        - model
        - choices
      properties:
        id:
          type: string
        object:
          type: string
          enum: [chat.completion.chunk]
        created:
          type: integer
        model:
          type: string
        choices:
          type: array
          items:
            $ref: '#/components/schemas/ChatCompletionChunkChoice'
        session_id:
          type: string
          description: Included in final chunk only

    ChatCompletionChunkChoice:
      type: object
      required:
        - index
        - delta
        - finish_reason
      properties:
        index:
          type: integer
        delta:
          type: object
          properties:
            content:
              type: string
        finish_reason:
          type: string
          enum: [stop, length, content_filter]
          nullable: true

    # Health/Status Schemas
    HealthResponse:
      type: object
      required:
        - status
        - version
        - backend
      properties:
        status:
          type: string
          enum: [ok]
        version:
          type: string
          example: '0.2.0'
        backend:
          type: string
          example: claude-code-cli
        claude_version:
          type: string
          nullable: true
          description: Claude Code CLI version
        uptime_seconds:
          type: integer
          description: Server uptime in seconds

    ModelsResponse:
      type: object
      required:
        - object
        - data
      properties:
        object:
          type: string
          enum: [list]
        data:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                example: claude-code-cli
              object:
                type: string
                enum: [model]
              created:
                type: integer
              owned_by:
                type: string
                example: anthropic

    # Error Schemas
    APIError:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - message
            - type
            - code
          properties:
            message:
              type: string
            type:
              type: string
              enum:
                - invalid_request_error
                - authentication_error
                - rate_limit_error
                - server_error
            code:
              type: string
              nullable: true
            details:
              type: object
              additionalProperties: true

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIError'
          example:
            error:
              message: Messages array is required and cannot be empty
              type: invalid_request_error
              code: validation_error

    RateLimited:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per minute
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in window
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when limit resets
        Retry-After:
          schema:
            type: integer
          description: Seconds until retry allowed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIError'
          example:
            error:
              message: Too many requests. Please slow down.
              type: rate_limit_error
              code: rate_limited
              details:
                retry_after: 30

    ServerError:
      description: Server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIError'
          example:
            error:
              message: Claude CLI execution failed
              type: server_error
              code: claude_cli_error
